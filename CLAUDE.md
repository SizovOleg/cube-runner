# CLAUDE.md — Инструкции для Claude Code

## Проект
**Cube Runner: Battle Dash** — 2D canvas-игра (платформер/раннер) на React + TypeScript.
Вдохновение: Red Ball (серия) — уровни с препятствиями и босс в конце каждого уровня.

## Технический стек
- **Runtime**: React 18 + TypeScript
- **Рендеринг**: HTML5 Canvas 2D (НЕ WebGL, НЕ Pixi.js)
- **Сборка**: Vite
- **Деплой**: статический билд → nginx на VPS (152.53.138.158) → https://earthfrom.space/games/cube-runner/
- **Тесты**: Vitest

## Архитектура

```
src/
├── engine/          # Игровой движок
│   ├── GameLoop.ts      # requestAnimationFrame loop, delta time
│   ├── Physics.ts       # Гравитация, коллизии AABB, платформы
│   ├── Camera.ts        # Камера с плавным следованием
│   ├── Input.ts         # Клавиатура + тач (unified)
│   ├── Renderer.ts      # Canvas рендеринг, слои отрисовки
│   └── ParticleSystem.ts # Частицы (взрывы, эффекты)
├── entities/        # Игровые объекты
│   ├── Player.ts        # Куб-игрок: движение, прыжок, стрельба
│   ├── Enemy.ts         # Базовый враг + типы врагов
│   ├── Boss.ts          # Базовый класс босса
│   ├── bosses/          # Конкретные боссы по уровням
│   │   ├── Boss1_Guardian.ts
│   │   ├── Boss2_Crusher.ts
│   │   └── ...
│   ├── Obstacle.ts      # Шипы, платформы, движущиеся блоки
│   ├── Powerup.ts       # Shield, Bomb, Rocket + новые
│   └── Bullet.ts        # Пули игрока и врагов
├── levels/          # Система уровней
│   ├── LevelManager.ts  # Загрузка, переключение, прогресс
│   ├── LevelBuilder.ts  # Построение уровня из данных
│   ├── types.ts         # Типы данных уровней
│   └── data/            # Данные уровней (JSON-like)
│       ├── level1.ts
│       ├── level2.ts
│       └── ...
├── ui/              # Интерфейс
│   ├── HUD.ts           # Score, HP, powerup slots
│   ├── Menu.ts          # Главное меню
│   ├── LevelSelect.ts   # Выбор уровня
│   ├── PauseScreen.ts   # Пауза
│   └── BossIntro.ts     # Заставка перед боссом
├── utils/           # Утилиты
│   ├── constants.ts     # Все константы (размеры, цвета, физика)
│   ├── math.ts          # Математические хелперы
│   └── storage.ts       # localStorage (прогресс, best score)
├── assets/          # Ресурсы (пока canvas-графика, подготовка под спрайты)
│   ├── sprites/
│   └── sounds/
├── App.tsx          # Корневой React-компонент
└── main.tsx         # Entry point
```

## Ключевые правила разработки

### Физика
- Гравитация: 0.45, прыжок: -8, полёт: -0.55 (текущие значения, сохранить)
- AABB коллизии для всех объектов
- Платформы: приземление сверху (one-way collision)
- Враги: убийство прыжком сверху ИЛИ стрельбой

### Система уровней
- Каждый уровень: фиксированная длина (не бесконечный)
- В конце уровня — арена босса (камера останавливается)
- После победы над боссом — экран победы → следующий уровень
- Прогресс сохраняется в localStorage

### Боссы (по типу Red Ball)
- У каждого босса: HP-бар, уникальные атаки, паттерны
- Босс-арена: замкнутое пространство, камера не скроллится
- Фазы: босс меняет поведение при потере HP
- Визуальная заставка перед боссом (имя, анимация появления)

### Canvas рендеринг
- Всё рисуется через Canvas 2D API
- Отрисовка слоями: фон → объекты → игрок → частицы → UI
- Glow-эффекты через shadowBlur (текущий стиль — сохранить)
- Неоновая цветовая палитра (сохранить текущую)

### Управление
- Клавиатура: Space/W/ArrowUp = прыжок, X/Z/Shift = стрельба, 1-2-3 = powerup
- Тач: тап по экрану = прыжок, кнопка GUN = стрельба, кнопки powerup
- Обязательно: единый Input manager для обоих типов ввода

### Мобильная версия
- Canvas масштабируется на весь экран
- Touch-кнопки видны только на тач-устройствах
- viewport-fit=cover, user-scalable=no

## Команды

```bash
npm run dev        # Запуск dev-сервера (Vite)
npm run build      # Production build → dist/
npm run preview    # Превью production build
npm run deploy     # scp dist/ на сервер
npm run test       # Vitest
npm run lint       # ESLint
```

## Текущие приоритеты (в порядке важности)
1. Рефакторинг монолита в модульную структуру
2. Система уровней с конечной длиной
3. Boss-система (Boss1 — первый)
4. Экран выбора уровней
5. Новые типы врагов
6. Звуковые эффекты (Web Audio API)
7. Мобильная оптимизация

## Стиль кода
- TypeScript strict mode
- Никаких однобуквенных переменных (текущий код — рефакторить)
- Интерфейсы для всех игровых объектов
- Комментарии на русском допустимы

## Известные проблемы текущего кода
- Весь код в одном файле с минифицированными именами
- Уровень генерируется процедурно и бесконечен — нужны фиксированные уровни
- Нет системы HP для игрока (мгновенная смерть)
- Нет сохранения прогресса между сессиями
- Powerup-система работает, но не масштабируется
